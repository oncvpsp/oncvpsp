## GHOST STATES, RESONANCES, and DETECTION

Bound states of the radial Schroedinger equation with a local potential are
strictly ordered in energy by their number of nodes.  This is not necessarily
true for separable non-local pseudopotentials.  Spurious bound states with
more nodes can arise below or between the zero- and one-node states which the
projectors are designed to reproduce.  While in the case of single Kleinman-
Bylander projectors, a simple test can predict their presence from the bound 
states of the local potential and the non-local projector coefficient,
(Ref. 25 of the paper), no such test exists for multiple-projector potentials.

### New Approach

A new "ghost detector" has been introduced in 3.3.0.  This will detect
deeply bound ghosts unlikely to found in the log-derivaive plots because
they are below the limits for any useful scan of the valence region.
The routine solves the problem of the pseudo-atom surrounded by a spherical
hard wall by a basis function method, mimicking how ghosts would show up
in a plane-wave calculation.  For each angular momentum, the routine computes
a set of radial basis functions that allow efficient calculation of a 
Hamiltonian matrix of the walled pseudopotential, and diagonalizes it.  
Eigenvalues lying below the wanted bound states (of the un-walled atom)
are tagged as ghosts.  "Proper" eigenvalues fall above these states because
of the wall, although very close for deeply-bound states.  These are 
simply compared to the unwalled radial Schroeinger equation eigenvalues
in the new "Testing for bound ghosts" section of the output file. The
effective basis cutoff energies of the basis functions are also listed.
Ghosts are reliably found even if they are too localized to be well converged.

Note that the "old" log-derivative plots of the valence region remain the
only way to assess the general quality of the potential and identify
shallow  bound ghosts of ghost resonances above 0.

Our old 14_Si_GHOST.dat illustration proves to be an embarrassment.  While
one bound ghost (l=1, -3.03 Ha) and two ghost resonances are found in the
log plots, the new routine finds 4 more deeply-bound ghosts.  The choice
of local potential here was deliberately very non-realistic.  A new
example is 60_Nd_GHOST, first found by a user with strange results in
a solid-state calculation.  Here, there is one extremely deep f ghost
(-208 Ha), whose basis-set-derived wave function is plotted in Nd_ghost.png
in this directory.  This ghost goes away if lpopt is set to 5 instead of 3.

There is no real theory for getting rid of ghosts, but adjusting the local
potential to be closer to the semi-local potential of the ghost l often
works.

This test should be considered only "beta" until users have more experience
with it.  It has not yet (as of 3.3.0) been implemented for relativistic
calculations, but a scalar-relativistic calculation with the same input
should be a reliable test.

### Old Approach

Our approach is to compute phi(E) = arctan(R * d psi(r)/dr |_R) for some R 
greater than the core radius, where psi is the solution of the non-local 
radial equation regular at the origin (ie., the outward-integrated solution).
Scanning downward in energy, usually from a positive energy of a few Ha, phi(E)
for the corresponding all-electron potential takes smooth positive steps
of pi, with the steps becoming sharper and corresponding to increasingly
localized bound states at increasingly negative energies.  Since it is only
possible to compute phi on [-pi, pi], steps of 2 pi must be added for
continuity as E decreases.  For a well-designed pseudopotential, the
corresponding phi(E) will closely track that of the all-electron potential
over a wide range of energies from well-below to well-above the valence
and semi-core states of interest.  The steps of pi indicate localized
pseudo wave functions.  Spurious steps of pi indicate "ghost" states, which
are localized states than on investigation turn out to have more nodes
than appropriate for their energies.

Ghosts are illustrated by the badly-designed 12_Si_GHOST psp generated by
the corresponding data file.  (To get something so bad an absurdly attractive
and long-ranged local potential was introduced.)  Examining the phi plots,
the s channel has a rather sharp "ghost resonance" at +1.8 Ha.  The p channel
has an extremely sharp ghost at -3 Ha, about 0.5 Ha above the core state
seen as a similar jump in the all-electron phi.  This psp isn't supposed to
produce core states.  Finally, the d channel has an extremely sharp
scattering resonance at +1.3 Ha.  When this resonant scattering state
is normalized on [0, 6 a_B], it has three peaks and two nodes inside 2 a_B,
and the slowly-periodic tail from 2 to 6 is nearly zero.  One wonders
what sort of a spurious conduction band this would yield!

The routine vkbphsft implements the phi calculations aligning the full-
potential and pseudopotential plots at the energy of the first projector
using an appropriate multiple of pi.  There is, however, a difficulty
which can result in a spurious indication of a ghost.  Due to the structure
of the separable non-local radial equation, the signs of psi and d psi/dr
can change abruptly at a discrete energy, giving rise to a spurious jump
of pi in phi which can in fact be either positive or negative.  This does
not correspond to a spurious localized state -- except for the arbitrary
sign, psi changes smoothly with no localized features around this energy.
Having identified this problem, in release 2.0.1 we have implemented
an algorithm which has so far proven accurate is distinguishing rapid but
continuous pi steps from such "sign-change" abrupt jumps.  For the abrupt
jumps, pi is added or subtracted to cancel them out.  Sharp but continuous
jumps are let stand, be they desired semi-core states or ghosts to be
identified as such.

As the search algorithm implemented in the last section of vkbphsft was
developed and tested, steps corresponding to deep but correct semi-cores
were sometimes canceled.  This was corrected by driving the search to
smaller energy intervals and loosening the criterion for "less than a
change of pi," but the absence of an expected semi-core step might still
occur.  If the diagnostic tests in the output file show that the psp has
an accurate bound semi-core it does, and its absence in the plot can be
ignored.  It is also possible that a perversely sharp ghost step could
be mistakenly canceled.  However, our two-projector potentials are
remarkably free of real ghosts, while sign-changes have been found often
enough to warrant the new procedure.
